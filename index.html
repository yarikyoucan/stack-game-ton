<!-- index.html -->
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#0f172a" />
  <title>Stack Game</title>

  <!-- Telegram Mini Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>

  <style>
    :root{ --topbar-h:56px; --menu-h:64px; }
    *{ box-sizing:border-box }
    body{
      margin:0;font-family:Arial,sans-serif;background:#0f172a;
      display:flex;flex-direction:column;height:100vh;padding-bottom:var(--menu-h);
    }
    .page{flex:1;display:none;overflow:auto;padding:10px}
    .page.active{display:block}

    /* ===== Верхня панель — лише на вкладці "Гра" ===== */
    #game .topbar{
      position:fixed;top:0;left:0;right:0;height:var(--topbar-h);
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 12px;background:rgba(15,23,42,.88);
      backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.15);
      z-index:1000;
    }
    .tb-left,.tb-mid,.tb-right{display:flex;align-items:center;gap:10px}
    .tb-left{min-width:0} .tb-mid{gap:8px} .tb-right{gap:10px}
    .tb-left img{
      width:32px;height:32px;border-radius:50%;object-fit:cover;
      border:2px solid rgba(255,255,255,.9)
    }
    .tg-tag{
      color:#fff;font-weight:800;letter-spacing:.2px;line-height:1;
      max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    /* однакова висота */
    #score,#highscore,.lang-btn{height:32px;display:flex;align-items:center;line-height:1}
    #score,#highscore{
      background:rgba(255,255,255,.12);color:#fff;padding:0 12px;border-radius:10px;
      font-weight:800;border:1px solid rgba(255,255,255,.25)
    }
    .lang-btn{
      background:rgba(255,255,255,.12);color:#eaf2ff;border:1px solid rgba(255,255,255,.25);
      padding:0 12px;border-radius:10px;font-weight:800;letter-spacing:.5px;cursor:pointer;backdrop-filter:blur(6px)
    }
    .lang-btn:hover{filter:brightness(1.05)}

    /* НИЖНЄ МЕНЮ */
    .menu{
      display:flex;justify-content:space-around;border-top:1px solid rgba(255,255,255,.15);
      background:rgba(15,23,42,.75);padding:10px 0;position:fixed;left:0;right:0;bottom:0;
      z-index:9999;backdrop-filter:blur(6px)
    }
    .menu button{flex:1;background:none;border:none;font-size:22px;cursor:pointer;color:#fff}
    .menu button.active{color:#3b82f6;font-weight:bold}

    /* Картки/кнопки */
    .task{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:15px;margin:10px auto;border-radius:10px;width:90%;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .task button{background:#007bff;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .task button.done{background:#28a745}
    .task button:disabled{opacity:.6;cursor:not-allowed}
    .balance{font-size:20px;margin-bottom:20px;text-align:center}

    /* ===== Гра ===== */
    #container{
      position:relative;width:100%;height:100%;overflow:hidden;
      padding-top:calc(var(--topbar-h) + 8px); /* щоб нічого не лізло під topbar */
      background:
        url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160">\
  <defs><radialGradient id="g" cx="40%" cy="40%" r="60%"><stop offset="0%" stop-color="%23fff9c4"/><stop offset="50%" stop-color="%23ffe082"/><stop offset="100%" stop-color="%23ffd54f00"/></radialGradient><clipPath id="crescent"><circle cx="80" cy="80" r="44"/></clipPath></defs>\
  <circle cx="80" cy="80" r="46" fill="%23ffe082" opacity="0.95"/><g clip-path="url(%23crescent)"><circle cx="68" cy="78" r="60" fill="url(%23g)"/></g>\
</svg>') no-repeat 95% 8%,
        url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><g fill="%23ffffff" opacity="0.7">\
<circle cx="15" cy="10" r="1.2"/><circle cx="40" cy="28" r="0.9"/><circle cx="85" cy="20" r="1.1"/><circle cx="120" cy="36" r="1.3"/><circle cx="60" cy="54" r="0.8"/><circle cx="18" cy="72" r="1.0"/><circle cx="100" cy="78" r="1.1"/><circle cx="130" cy="92" r="0.9"/><circle cx="32" cy="110" r="1.2"/><circle cx="72" cy="118" r="0.9"/><circle cx="8" cy="126" r="1.0"/>\
</g></svg>') repeat,
        linear-gradient(180deg,#1e1b4b 0%, #0b1020 60%, #090f1a 100%);
      background-size:160px 160px,140px 140px,cover;
      background-position:95% 8%,center,center;
    }
    #container canvas{
      position:absolute!important;top:0;left:0;width:100%!important;height:100%!important;
      z-index:1!important;background:transparent!important
    }
    #instructions{
      position:absolute;top:calc(var(--topbar-h) + 14px);left:10px;color:#fff;font-size:16px;
      background:rgba(0,0,0,.4);padding:4px 8px;border-radius:6px;z-index:2
    }
    .hide{display:none}
    .game-over,.ready{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      text-align:center;background:rgba(15,23,42,.95);color:#fff;padding:20px;border-radius:10px;
      display:none;z-index:3;min-width:260px;box-shadow:0 2px 5px rgba(0,0,0,.35)
    }

    /* ===== Непрозорі багатоповерхівки (тільки у вкладці "Гра") ===== */
    .city-skyline{
      position:fixed;left:0;right:0;bottom:var(--menu-h);height:36vh;
      display:flex;align-items:flex-end;gap:10px;padding:0 12px;
      z-index:0;pointer-events:none;
    }
    .city-skyline .bldg{
      width:clamp(44px,7vw,96px);height:var(--h,24vh);
      background:#1f2937;border:1px solid #111827;border-radius:3px;
      box-shadow:inset 0 -2px 0 rgba(255,255,255,.04),0 8px 24px rgba(0,0,0,.45);
      position:relative;
    }
    .city-skyline .bldg::before{
      content:"";position:absolute;left:0;right:0;top:-3px;height:3px;background:#111827;border-radius:2px 2px 0 0;
    }
    .city-skyline .bldg::after{
      content:"";position:absolute;inset:10px;
      background-image:radial-gradient(#ffd166 1.6px, transparent 1.8px);
      background-size:14px 14px;opacity:.9;filter:drop-shadow(0 0 1px rgba(0,0,0,.25));
    }

    /* Темні теми сторінок (без зміни розмірів/розташування елементів) */
    .share-card{width:90%;margin:12px auto;background:#fff;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1);padding:16px}
    .share-row{display:flex;gap:8px;margin-top:8px}
    .share-row input{flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    .share-actions{display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#007bff;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-block}
    .muted{color:#c7d2fe;font-size:12px}
    .ok{color:#198754}.err{color:#dc3545}
    .payout-list{list-style:none;margin:8px 0 0;padding:0}
    .payout-list li{padding:6px 8px;border:1px solid #eee;border-radius:8px;margin-top:6px;font-size:14px}

    .themed{
      position:relative;color:#eef;padding-bottom:calc(var(--menu-h) + 20px);
      background:
        radial-gradient(1200px 500px at 15% 0%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(1000px 600px at 85% 100%, rgba(56,189,248,.25), transparent 60%),
        linear-gradient(135deg,#0f172a 0%, #1e1b4b 45%, #3b82f6 100%);
    }
    #tasks.themed{
      background-image:
        radial-gradient(1200px 500px at 15% 0%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(1000px 600px at 85% 100%, rgba(56,189,248,.25), transparent 60%),
        linear-gradient(135deg,#0f172a 0%, #1e1b4b 45%, #3b82f6 100%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="620" height="180"><g fill="%23ffffff1f" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="800" transform="rotate(-18 310 90)"><text x="-60" y="40">TASKS • TASKS • TASKS • TASKS • TASKS •</text><text x="-60" y="100">TASKS • TASKS • TASKS • TASKS • TASKS •</text><text x="-60" y="160">TASKS • TASKS • TASKS • TASKS • TASKS •</text></g></svg>');
      background-size:auto,auto,auto,620px 180px;background-repeat:no-repeat,no-repeat,no-repeat,repeat;
    }
    #friends.themed{
      background-image:
        radial-gradient(1200px 500px at 15% 0%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(1000px 600px at 85% 100%, rgba(56,189,248,.25), transparent 60%),
        linear-gradient(135deg,#0f172a 0%, #1e1b4b 45%, #3b82f6 100%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="640" height="180"><g fill="%23ffffff1f" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="800" transform="rotate(-18 320 90)"><text x="-60" y="40">WALLET • WALLET • WALLET • WALLET • WALLET •</text><text x="-60" y="100">WALLET • WALLET • WALLET • WALLET • WALLET •</text><text x="-60" y="160">WALLET • WALLET • WALLET • WALLET • WALLET •</text></g></svg>');
      background-size:auto,auto,auto,640px 180px;background-repeat:no-repeat,no-repeat,no-repeat,repeat;
    }
    #shop.themed{
      background-image:
        radial-gradient(1200px 500px at 15% 0%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(1000px 600px at 85% 100%, rgba(56,189,248,.25), transparent 60%),
        linear-gradient(135deg,#0f172a 0%, #1e1b4b 45%, #3b82f6 100%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="640" height="180"><g fill="%23ffffff1a" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="800" transform="rotate(-18 320 90)"><text x="-60" y="40">SHOP • SHOP • SHOP • SHOP • SHOP •</text><text x="-60" y="100">SHOP • SHOP • SHOP • SHOP • SHOP •</text><text x="-60" y="160">SHOP • SHOP • SHOP • SHOP • SHOP •</text></g></svg>');
      background-size:auto,auto,auto,640px 180px;background-repeat:no-repeat,no-repeat,no-repeat,repeat;
    }

    /* ===== Лідерборд ===== */
    #leaderboard.themed{
      background-image:
        radial-gradient(1200px 500px at 15% 0%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(1000px 600px at 85% 100%, rgba(56,189,248,.25), transparent 60%),
        linear-gradient(135deg,#0f172a 0%, #1e1b4b 45%, #3b82f6 100%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="760" height="200"><g fill="%23ffffff15" font-family="Arial, Helvetica, sans-serif" font-size="36" font-weight="800" transform="rotate(-18 380 100)"><text x="-60" y="40">LEADERBOARD • LEADERBOARD • LEADERBOARD •</text><text x="-60" y="100">LEADERBOARD • LEADERBOARD • LEADERBOARD •</text><text x="-60" y="160">LEADERBOARD • LEADERBOARD • LEADERBOARD •</text></g></svg>');
      background-size:auto,auto,auto,760px 200px;background-repeat:no-repeat,no-repeat,no-repeat,repeat;
      color:#eaf2ff; padding-bottom:calc(var(--menu-h) + 20px);
    }
    .lb-header{width:92%;margin:12px auto 8px}
    .lb-title{font-size:26px;margin:0 0 4px}
    .lb-sub{opacity:.9;margin:0 0 10px}
    .lb-note{width:92%;margin:4px auto 16px;font-size:13px;opacity:.9}
    #lbList{width:92%;margin:0 auto 18px}
    .lb-row{
      display:grid;
      grid-template-columns:56px 1fr 70px 90px;
      align-items:center;gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;border-radius:12px;
      backdrop-filter:blur(6px);
      box-shadow:0 8px 20px rgba(0,0,0,.15);
      margin:0 0 8px 0;
    }
    .lb-rank{font-weight:900;font-size:18px;text-align:center}
    .lb-name{display:flex;align-items:center;gap:10px;min-width:0}
    .lb-name img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.3)}
    .lb-name .txt{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .lb-bonus{text-align:center;font-weight:800;opacity:.95}
    .lb-score{text-align:right;font-weight:800}
    .rank-1{background:linear-gradient(135deg,rgba(250,204,21,.25),rgba(255,255,255,.06));border-color:rgba(250,204,21,.6)}
    .rank-2{background:linear-gradient(135deg,rgba(148,163,184,.25),rgba(255,255,255,.06));border-color:rgba(148,163,184,.6)}
    .rank-3{background:linear-gradient(135deg,rgba(244,114,182,.25),rgba(255,255,255,.06));border-color:rgba(244,114,182,.6)}
  </style>

  <!-- Adexium SDK -->
  <script src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
  <script>
    (function () {
      const WID='8d2ce1f1-ae64-4fc3-ac46-41bc92683fae', FORMAT='interstitial';
      const _adex = window.__adex = window.__adex || { ready:false, widget:null, queue:[], pendingAd:undefined };
      window.__getAdexium = function (cb) {
        if (typeof cb !== 'function') return;
        if (_adex.ready && _adex.widget) cb(_adex.widget); else _adex.queue.push(cb);
      };
      function initOnce(){
        if (_adex.ready) return;
        if (typeof window.AdexiumWidget !== 'function') { setTimeout(initOnce,80); return; }
        try {
          const adexiumAds = new AdexiumWidget({ wid: WID, adFormat: FORMAT, debug:false });
          _adex.widget = adexiumAds; _adex.ready = true;
          const emit = (name, detail) => window.dispatchEvent(new CustomEvent('adexium:'+name,{detail}));
          adexiumAds.on('adReceived',(ad)=>{_adex.pendingAd=ad;emit('adReceived',{ad});});
          adexiumAds.on('noAdFound',()=>{_adex.pendingAd=null;emit('noAdFound');});
          adexiumAds.on('adDisplayed',()=>emit('adDisplayed'));
          adexiumAds.on('adClosed',()=>emit('adClosed'));
          adexiumAds.on('adPlaybackCompleted',()=>emit('adPlaybackCompleted'));
          adexiumAds.on('adRedirected',()=>emit('adRedirected'));
          window.addEventListener('message',(ev)=>{
            const d=ev?.data; if(!d||typeof d!=='object'||d.source!=='adexium') return;
            if(d.type==='shown') emit('adDisplayed');
            if(d.type==='close'||d.type==='dismiss') emit('adClosed');
          });
          _adex.queue.splice(0).forEach(fn=>{try{fn(adexiumAds);}catch(_){}})
        } catch(e){ console.warn('[Adexium] init error:',e); }
      }
      document.addEventListener('DOMContentLoaded', initOnce);
      if (document.readyState==='interactive'||document.readyState==='complete') initOnce();
    })();
  </script>
</head>
<body>

  <!-- GAME -->
  <div id="game" class="page active">
    <div class="topbar">
      <div class="tb-left">
        <img id="tgAvatar" referrerpolicy="no-referrer" alt="Avatar"
             src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'><rect width='64' height='64' rx='12' fill='%239ca3af'/><circle cx='32' cy='24' r='12' fill='%23e5e7eb'/><path d='M10 54c0-10 10-16 22-16s22 6 22 16v4H10z' fill='%23e5e7eb'/></svg>'">
        <div id="tgTag" class="tg-tag">@guest</div>
      </div>
      <div class="tb-mid">
        <div id="score">0</div>
        <div id="highscore">🏆 0</div>
      </div>
      <div class="tb-right">
        <button id="langToggle" class="lang-btn">UA</button>
      </div>
    </div>

    <div id="container">
      <div id="instructions" data-i18n="instructions">
        Клік або пробіл — поставити блок. Після завершення — клікни/пробіл, щоб зіграти ще.
      </div>

      <div class="game-over" id="gameOver">
        <h2 data-i18n="game_over">Гра закінчена</h2>
        <p data-i18n="nice_try">Ти молодець 👍</p>
        <p data-i18n="restart_hint">Клікни або натисни пробіл, щоб почати знову</p>
      </div>

      <div class="ready" id="ready">
        <div id="start-button" style="cursor:pointer;" data-i18n="start_btn">▶ Старт</div>
      </div>

      <div class="game-over" id="postAdTimer" style="display:none;">
        <h2 data-i18n="pause_before_new_game">Пауза перед новою грою</h2>
        <p><span data-i18n="you_can_start_in">Можна буде почати через:</span>
          <b id="postAdCountdown">15</b> <span data-i18n="sec_suffix">с</span></p>
      </div>
    </div>

    <!-- Непрозорі багатоповерхівки: тільки у вкладці Гра -->
    <div class="city-skyline" id="citySkyline" aria-hidden="true"></div>
  </div>

  <!-- TASKS -->
  <div id="tasks" class="page themed">
    <h2 id="tasksTitle">📋 <span data-i18n="tasks_title">Завдання</span></h2>

    <div class="task">
      <span data-i18n="task_subscribe_text">Підпишись на канал +1⭐</span>
      <button id="subscribeBtn" class="btn" data-i18n="open">Перейти</button>
    </div>

    <div class="task" id="task50" style="justify-content:space-between;">
      <span data-i18n="task_75_text">🎯 Досягни рекорду 75 (+5.15⭐)</span>
      <button id="checkTask50" class="btn" style="margin-left:auto;" data-i18n="check">Перевірити</button>
    </div>

    <!-- Денні таски -->
    <div class="task" id="taskAdsgramDaily">
      <span>🎬 Adsgram: +0.1⭐ — <b id="adGramCounter">0</b>/25 сьогодні</span>
      <button id="watchAdsgramDailyBtn" class="btn">Дивитись</button>
    </div>

    <div class="task" id="taskAdexiumDaily">
      <span>🎬 Adexium: +0.1⭐ — <b id="adExCounter">0</b>/25 сьогодні</span>
      <button id="watchAdexiumDailyBtn" class="btn">Дивитись</button>
    </div>

    <!-- Квести 5/10 реклам -->
    <div class="task" id="taskWatch5">
      <span><span data-i18n="task_5ads_text">🎬 Переглянь 5 реклам (+1⭐)</span> — <b id="ad5Counter">0/5</b></span>
      <button id="watchAd5Btn" class="btn" data-i18n="watch">Дивитися</button>
    </div>
    <div class="task" id="taskWatch5Cooldown" style="display:none;">
      <span>⌛ <span data-i18n="task_5ads_available_in">«5 реклам» доступне через:</span>
        <span id="ad5CooldownText">—</span></span>
      <button class="btn" disabled data-i18n="wait">Очікуй…</button>
    </div>

    <div class="task" id="taskWatch10">
      <span><span data-i18n="task_10ads_text">🎬 Переглянь 10 реклам (+1.85⭐)</span> — <b id="ad10Counter">0/10</b></span>
      <button id="watchAd10Btn" class="btn" data-i18n="watch">Дивитися</button>
    </div>
    <div class="task" id="taskWatch10Cooldown" style="display:none;">
      <span>⌛ <span data-i18n="task_10ads_available_in">«10 реклам» доступне через:</span>
        <span id="ad10CooldownText">—</span></span>
      <button class="btn" disabled data-i18n="wait">Очікуй…</button>
    </div>

    <div class="task" id="taskGames100" style="justify-content:space-between;">
      <span data-i18n="task_100games_text">🎮 Зіграй 100 ігор (+5⭐) — зіграно:
        <b id='gamesPlayedCounter'>0</b>/100</span>
      <button id="checkGames100Btn" class="btn" style="margin-left:auto;" data-i18n="check">Перевірити</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="page themed">
    <div class="lb-header">
      <h2 class="lb-title">🏆 <span data-i18n="lb_title">Лідерборд</span></h2>
      <div class="lb-sub" data-i18n="lb_sub">Попадай у ТОП — отримуй більше ⭐ за місце!</div>
    </div>
    <div id="lbList"></div>
    <div class="lb-note" id="lbNote"></div>
  </div>

  <!-- TOURNAMENTS -->
  <div id="tournaments" class="page">
    <div class="tour-hero">
      <div class="tour-hero-title" data-i18n="b_tour_title">⚔️ Виклик суперника</div>
      <div class="tour-hero-sub" data-i18n="b_tour_sub">Згенеруй рекорд, зроби ставку ⭐ і побий його за 3 години</div>
    </div>

    <div class="challenge-card">
      <div class="challenge-row">
        <div>
          <div class="muted" data-i18n="opponent">Суперник</div>
          <div class="opponent-score" id="opponentScore">—</div>
        </div>
        <button class="btn" id="genOpponentBtn" data-i18n="generate">Згенерувати</button>
      </div>

      <div class="challenge-row">
        <label for="stakeInput" class="muted" data-i18n="stake">Ставка ⭐</label>
        <div class="stake-wrap">
          <input id="stakeInput" type="number" min="1" step="0.5" value="1" />
          <button class="btn" id="startChallengeBtn" data-i18n="start_challenge">Почати виклик (3 год)</button>
        </div>
      </div>

      <div class="challenge-info" id="challengeInfo" data-i18n="no_active_challenge">Немає активного виклику.</div>

      <div class="challenge-countdown" id="challengeCountdown" style="display:none;">
        ⏳ <span data-i18n="time_left_prefix">Залишилось:</span> <span id="challengeLeft">03:00:00</span>
      </div>

      <div class="challenge-actions">
        <button class="btn" id="checkChallengeBtn" disabled data-i18n="check">Перевірити</button>
        <span id="challengeStatus" class="muted"></span>
      </div>
    </div>

    <div class="battle-panel" aria-label="Правила батлу" style="width:92%; margin:14px auto calc(var(--menu-h) + 32px);border-radius:16px; overflow:hidden;background:
      linear-gradient(135deg, rgba(30,27,75,.85), rgba(37,99,235,.85)),
      url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;280&quot; height=&quot;280&quot; viewBox=&quot;0 0 280 280&quot;><g fill=&quot;none&quot; stroke=&quot;%23ffffff22&quot;><path d=&quot;M0 40h280M0 80h280M0 120h280M0 160h280M0 200h280M0 240h280&quot;/><path d=&quot;M40 0v280M80 0v280M120 0v280M160 0v280M200 0v280M240 0v280&quot;/></g></svg>') center/280px repeat;
      border:1px solid rgba(255,255,255,.18);color:#eaf2ff; box-shadow:0 10px 30px rgba(0,0,0,.2)">
      <div class="inner" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px">
        <div class="title" style="display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.5px;text-transform:uppercase">
          <div class="logo" style="width:38px;height:38px;border-radius:12px;background:radial-gradient(circle at 30% 30%, #93c5fd, #6366f1);box-shadow:inset 0 1px 0 rgba(255,255,255,.35), 0 6px 16px rgba(99,102,241,.35);display:grid;place-items:center;font-size:20px">⚔️</div>
          <div>BATTLES</div>
        </div>
        <div class="rules" style="display:flex;gap:10px;flex:1;min-width:220px;justify-content:center;flex-wrap:wrap">
          <div class="pill" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px" data-i18n="rule_goal">🎯 Мета: побий рекорд за 3 год</div>
          <div class="pill" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px" data-i18n="rule_prize">💎 Виграш: ×1.5 від ставки</div>
          <div class="pill" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px" data-i18n="rule_risk">⚠️ Якщо не встигаєш — ставка згорає</div>
        </div>
        <div class="cta" style="display:flex;gap:8px;align-items:center">
          <button class="btn" onclick="document.getElementById('stakeInput').focus()" data-i18n="make_bet">Зробити ставку</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FRIENDS / WALLET -->
  <div id="friends" class="page themed">
    <div class="balance"><span data-i18n="balance">Баланс</span> ⭐ <span id="balance">0</span></div>
    <h2 class="wallet-title">💳 <span data-i18n="wallet">Гаманець</span></h2>

    <div class="share-card">
      <div><strong data-i18n="invite_friends">Запроси друзів</strong></div>
      <p class="muted" data-i18n="bot_link">Посилання на бота:</p>
      <p style="margin:8px 0;">
        <a href="https://t.me/Stacktongame_bot" class="btn" onclick="openBotLink(event)" data-i18n="open_bot">➡ Відкрити бота @Stacktongame_bot</a>
      </p>
      <div class="share-row">
        <input id="shareLink" type="text" readonly value="https://t.me/Stacktongame_bot"/>
        <button class="btn" id="copyShareBtn" data-i18n="copy">Скопіювати</button>
      </div>
      <div class="muted" data-i18n="one_link">Це одна силка для всіх 👍</div>
    </div>

    <div class="share-card">
      <div><strong data-i18n="withdraw_title">Вивід зірок</strong></div>
      <div class="muted" data-i18n="withdraw_hint">
        За натискання списується рівно 50⭐, решта лишається. Далі відкриється група/«Поділитися» з готовим повідомленням і двома кодами.
      </div>
      <div class="share-actions">
        <button class="btn" id="withdrawBtn" data-i18n="withdraw_btn">Вивести</button>
        <span id="withdrawStatus" class="muted"></span>
      </div>
    </div>

    <div class="share-card">
      <div><strong data-i18n="payout_list_title">Список виводів</strong></div>
      <ul id="payoutList" class="payout-list"></ul>
    </div>
  </div>

  <!-- SHOP -->
  <div id="shop" class="page themed">
    <h2 class="wallet-title" style="margin-top:12px">🛒 <span data-i18n="shop_announcements">Оголошення</span></h2>

    <div class="share-card shop-card" style="text-align:center; position:relative;">
      <button class="info-btn" id="shopInfoBtn" aria-label="Info" style="position:absolute; right:12px; top:12px; width:28px;height:28px;border-radius:999px;border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.12); color:#fff;">i</button>

      <div class="info-pop" id="shopInfoPop" style="display:none; margin-top:8px;">
        <p data-i18n="shop_info_text">Якщо бажаєте продати NFT, зірки чи інші подарунки — пишіть у лс.</p>
        <button class="btn" id="shopInfoClose" data-i18n="close">Закрити</button>
      </div>

      <p style="margin:6px 0 14px" class="muted"><span data-i18n="post_announcement">Виставити оголошення</span></p>
      <button class="btn" id="dmOwnerBtn" data-i18n="write_dm">Написати в лс</button>
      <div class="muted" style="margin-top:8px">@yArOsUlAv</div>
    </div>
  </div>

  <!-- НИЖНЄ МЕНЮ -->
  <div class="menu">
    <button onclick="showPage('game', this)" class="active">🎮</button>
    <button onclick="showPage('tasks', this)">📝</button>
    <button onclick="showPage('leaderboard', this)">🏆</button>
    <button onclick="showPage('tournaments', this)">⚔️</button>
    <button onclick="showPage('friends', this)">👛</button>
    <button onclick="showPage('shop', this)">🛍️</button>
  </div>

  <!-- Бібліотеки гри/реклами -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r83/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

  <!-- RichAds -->
  <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
  <script>
    window.TelegramAdsController = new TelegramAdsController();
    window.TelegramAdsController.initialize({ pubId: "965326", appId: "3592" });
  </script>

  <!-- App helpers + i18n -->
  <script>
    function showPage(id, btn){
      document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id===id));
      document.querySelectorAll('.menu button').forEach(b => b.classList.toggle('active', b===btn));
      window.isPaused = (id !== 'game');
      if(id==='leaderboard'){ loadLeaderboard?.(); }
    }
    function openBotLink(e){
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openTelegramLink('https://t.me/Stacktongame_bot');
        e.preventDefault();
      }
    }
    function openDMto(username){
      const url = 'https://t.me/' + username.replace(/^@/,'');
      if (window.Telegram && Telegram.WebApp) Telegram.WebApp.openTelegramLink(url);
      else window.open(url,'_blank');
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('dmOwnerBtn')?.addEventListener('click', ()=>openDMto('@yArOsUlAv'));
      const infoBtn = document.getElementById('shopInfoBtn');
      const infoPop = document.getElementById('shopInfoPop');
      const infoClose = document.getElementById('shopInfoClose');
      infoBtn?.addEventListener('click', ()=>{ infoPop.style.display = (infoPop.style.display==='block'?'none':'block'); });
      infoClose?.addEventListener('click', ()=>{ infoPop.style.display='none'; });
      document.addEventListener('click', (e)=>{
        if (!infoPop || !infoBtn) return;
        if (!infoPop.contains(e.target) && !infoBtn.contains(e.target)) infoPop.style.display='none';
      });
    });
  </script>

  <!-- Лідерборд (GitHub) -->
  <script>
    const LB_URL = 'https://raw.githubusercontent.com/yarikyoucan/stack-game-ton/main/leaderboard.json';
    function _avatarSvg(){
      return 'data:image/svg+xml;utf8,'+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28'><rect width='28' height='28' rx='14' fill='#1f2a44'/><text x='14' y='18' text-anchor='middle' font-size='14' fill='#9fb3ff'>👤</text></svg>");
    }
    async function fetchLeaderboard(){
      if(!LB_URL) return null;
      const url = LB_URL + (LB_URL.includes('?')?'&':'?') + 'v=' + Date.now();
      const r = await fetch(url,{headers:{'accept':'application/json'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      if(!Array.isArray(data)) throw new Error('Bad JSON format');
      return data;
    }
    function renderLeaderboard(rows){
      const list = document.getElementById('lbList');
      const note = document.getElementById('lbNote');
      if(!list) return;
      rows = Array.isArray(rows)? rows.slice(): [];
      rows.sort((a,b)=> (b?.score||0)-(a?.score||0));
      list.innerHTML='';
      for(let i=0;i<50;i++){
        const r = rows[i];
        const rank = i+1;
        const name = r ? (r.name || 'Player') : '—';
        const score = (r && typeof r.score==='number') ? r.score : '—';
        const row = document.createElement('div');
        row.className = 'lb-row ' + (rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':'');
        row.innerHTML = `
          <div class="lb-rank">${rank}</div>
          <div class="lb-name"><img src="${_avatarSvg()}" alt=""><span class="txt">${name}</span></div>
          <div class="lb-bonus">?⭐</div>
          <div class="lb-score">${score}</div>
        `;
        list.appendChild(row);
      }
      if(note) note.textContent = 'Оновлено з GitHub.';
    }
    async function loadLeaderboard(){
      try{
        const data = await fetchLeaderboard();
        renderLeaderboard(data||[]);
      }catch(e){
        renderLeaderboard([]);
        const note = document.getElementById('lbNote');
        if(note) note.textContent = 'Не вдалось завантажити лідерборд.';
        console.warn('LB load error:', e);
      }
    }
    window.loadLeaderboard = loadLeaderboard;
    document.addEventListener('DOMContentLoaded', ()=>{
      if(document.getElementById('leaderboard')?.classList.contains('active')){
        loadLeaderboard();
      }
    });
  </script>

  <!-- I18N -->
  <script>
    const I18N = {
      uk: {
        instructions: "Клік або пробіл — поставити блок. Після завершення — клікни/пробіл, щоб зіграти ще.",
        game_over: "Гра закінчена",
        nice_try: "Ти молодець 👍",
        restart_hint: "Клікни або натисни пробіл, щоб почати знову",
        start_btn: "▶ Старт",
        pause_before_new_game: "Пауза перед новою грою",
        you_can_start_in: "Можна буде почати через:",
        sec_suffix: "с",

        tasks_title: "Завдання",
        task_subscribe_text: "Підпишись на канал +1⭐",
        open: "Перейти",
        done: "Виконано",
        task_75_text: "🎯 Досягни рекорду 75 (+5.15⭐)",
        check: "Перевірити",

        b_tour_title: "⚔️ Виклик суперника",
        b_tour_sub: "Згенеруй рекорд, зроби ставку ⭐ і побий його за 3 години",
        opponent: "Суперник",
        generate: "Згенерувати",
        stake: "Ставка ⭐",
        start_challenge: "Почати виклик (3 год)",
        no_active_challenge: "Немає активного виклику.",
        time_left_prefix: "Залишилось:",
        rule_goal: "🎯 Мета: побий рекорд за 3 год",
        rule_prize: "💎 Виграш: ×1.5 від ставки",
        rule_risk: "⚠️ Якщо не встигаєш — ставка згорає",
        make_bet: "Зробити ставку",

        balance: "Баланс",
        wallet: "Гаманець",
        invite_friends: "Запроси друзів",
        bot_link: "Посилання на бота:",
        open_bot: "➡ Відкрити бота @Stacktongame_bot",
        copy: "Скопіювати",
        one_link: "Це одна силка для всіх 👍",
        withdraw_title: "Вивід зірок",
        withdraw_hint: "За натискання списується рівно 50⭐, решта лишається. Далі відкриється група/«Поділитися» з готовим повідомленням і двома кодами.",
        withdraw_btn: "Вивести",
        payout_list_title: "Список виводів",

        shop_announcements: "Оголошення",
        post_announcement: "Виставити оголошення",
        write_dm: "Написати в лс",
        shop_info_text: "Якщо бажаєте продати NFT, зірки чи інші подарунки — пишіть у лс.",
        close: "Закрити",

        lb_title: "Лідерборд",
        lb_sub: "Попадай у ТОП — отримуй більше ⭐ за місце!"
      },
      en: {
        instructions: "Click or Space — drop the block. After game over, click/space to play again.",
        game_over: "Game Over",
        nice_try: "Nice try 👍",
        restart_hint: "Click or press Space to start again",
        start_btn: "▶ Start",
        pause_before_new_game: "Pause before new game",
        you_can_start_in: "You can start in:",
        sec_suffix: "s",

        tasks_title: "Tasks",
        task_subscribe_text: "Subscribe to channel +1⭐",
        open: "Open",
        done: "Done",
        task_75_text: "🎯 Reach 75 highscore (+5.15⭐)",
        check: "Check",

        b_tour_title: "⚔️ Challenge an opponent",
        b_tour_sub: "Generate a target, place a ⭐ bet and beat it within 3 hours",
        opponent: "Opponent",
        generate: "Generate",
        stake: "Stake ⭐",
        start_challenge: "Start challenge (3h)",
        no_active_challenge: "No active challenge.",
        time_left_prefix: "Time left:",
        rule_goal: "🎯 Goal: beat the score in 3 hours",
        rule_prize: "💎 Prize: ×1.5 of your stake",
        rule_risk: "⚠️ If you fail — you lose the stake",
        make_bet: "Make a bet",

        balance: "Balance",
        wallet: "Wallet",
        invite_friends: "Invite friends",
        bot_link: "Bot link:",
        open_bot: "➡ Open @Stacktongame_bot",
        copy: "Copy",
        one_link: "Same link for everyone 👍",
        withdraw_title: "Withdraw stars",
        withdraw_hint: "Clicking deducts exactly 50⭐, the rest stays. You’ll then open a group/Share with a ready message and two codes.",
        withdraw_btn: "Withdraw",
        payout_list_title: "Payouts",

        shop_announcements: "Announcements",
        post_announcement: "Post an announcement",
        write_dm: "Message in DM",
        shop_info_text: "If you want to sell NFTs, stars or other gifts — message me in DM.",
        close: "Close",

        lb_title: "Leaderboard",
        lb_sub: "Climb the TOP — earn more ⭐ for your rank!"
      }
    };
    function applyLang(lang){
      const dict = I18N[lang] || I18N.uk;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (dict[key] != null) el.innerHTML = dict[key];
      });
      const subBtn=document.getElementById('subscribeBtn');
      if (subBtn){
        const subscribed=(localStorage.getItem('subscribed')==='true');
        subBtn.textContent = subscribed ? dict.done : dict.open;
      }
      const btn=document.getElementById('langToggle');
      if (btn) btn.textContent = (lang==='en'?'EN':'UA');
      localStorage.setItem('lang', lang);
      document.documentElement.setAttribute('lang', lang==='en'?'en':'uk');
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const saved = localStorage.getItem('lang') || 'uk';
      applyLang(saved);
      document.getElementById('langToggle')?.addEventListener('click', ()=>{
        const cur = localStorage.getItem('lang') || 'uk';
        applyLang(cur==='uk' ? 'en' : 'uk');
      });
    });
  </script>

  <!-- Автотег + аватар з Telegram -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      try { tg?.expand?.(); } catch(e) {}
      const user = tg?.initDataUnsafe?.user || null;
      const tagEl = document.getElementById('tgTag');
      const avatarEl = document.getElementById('tgAvatar');

      let display='@guest';
      if (user?.username) display='@'+user.username;
      else if (user?.first_name || user?.last_name) display=[user.first_name,user.last_name].filter(Boolean).join(' ');
      if (tagEl) tagEl.textContent = display;

      if (user?.photo_url && avatarEl){
        avatarEl.src = user.photo_url;
        avatarEl.addEventListener('error', () => {
          fetch(user.photo_url, {cache:'no-store'})
            .then(r => r.blob())
            .then(b => new Promise(res => {const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b);} ))
            .then(dataUrl => { avatarEl.src = dataUrl; })
            .catch(()=>{});
        }, {once:true});
      }
    });
  </script>

  <!-- Основна логіка гри -->
  <script src="./script.js"></script>

  <!-- Генерація багатоповерхівок (тільки для #game) -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const skyline = document.getElementById('citySkyline');
      if (!skyline) return;
      function buildSkyline(){
        skyline.innerHTML='';
        const count = Math.max(8, Math.round(window.innerWidth / 70));
        for (let i=0;i<count;i++){
          const b=document.createElement('div');
          b.className='bldg';
          const h=Math.floor(Math.random()*20)+12; // 12–32vh
          b.style.setProperty('--h', h+'vh');
          skyline.appendChild(b);
        }
      }
      buildSkyline();
      window.addEventListener('resize', buildSkyline);
    });
  </script>
</body>
</html>

